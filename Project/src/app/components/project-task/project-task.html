<div class="page-container" dir="rtl">
  @if (errorMessage()) {
    <div class="error-message-container">
      <div class="error-message">
        <mat-icon>error</mat-icon>
        <p>{{ errorMessage() }}</p>
      </div>
    </div>
  }

  <section class="form-section">
    <mat-card class="add-task-card">
      <form [formGroup]="taskForm" (ngSubmit)="addTask()" class="modern-form">
        <div class="form-header">
          <div class="icon-wrapper">
            <mat-icon>add_task</mat-icon>
          </div>
          <div class="header-text">
            <h2>××©×™××” ×—×“×©×”</h2>
            <p>×”×•×¡×£ ××©×™××” ×—×“×©×” ×œ×¤×¨×•×™×§×˜</p>
          </div>
        </div>

        <div class="form-grid">
          <mat-form-field appearance="fill" class="form-field">
            <mat-label>×›×•×ª×¨×ª ×”××©×™××”</mat-label>
            <input matInput formControlName="title" placeholder="×©× ×”××©×™××”" aria-label="×›×•×ª×¨×ª ×”××©×™××”">
            <mat-icon matPrefix>edit_note</mat-icon>
            @if (taskForm.get('title')?.invalid && taskForm.get('title')?.touched) {
              <mat-error>×›×•×ª×¨×ª ×”×™× ×©×“×” ×—×•×‘×”</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="fill" class="form-field">
            <mat-label>×¡×˜×˜×•×¡</mat-label>
            <mat-select formControlName="status" aria-label="×‘×—×™×¨×ª ×¡×˜×˜×•×¡">
              <mat-option value="todo">ğŸ“‹ ×œ×‘×™×¦×•×¢</mat-option>
              <mat-option value="in_progress">âš™ï¸ ×‘×ª×”×œ×™×š</mat-option>
              <mat-option value="done">âœ… ×”×•×©×œ×</mat-option>
            </mat-select>
            <mat-icon matPrefix>flag</mat-icon>
            @if (taskForm.get('status')?.invalid && taskForm.get('status')?.touched) {
              <mat-error>×‘×—×™×¨×ª ×¡×˜×˜×•×¡ ×”×™× ×—×•×‘×”</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="fill" class="form-field">
            <mat-label>×¢×“×™×¤×•×ª</mat-label>
            <mat-select formControlName="priority" aria-label="×‘×—×™×¨×ª ×¢×“×™×¤×•×ª">
              <mat-option value="low">ğŸŸ¢ × ××•×›×”</mat-option>
              <mat-option value="normal">ğŸŸ¡ ×¨×’×™×œ×”</mat-option>
              <mat-option value="high">ğŸ”´ ×’×‘×•×”×”</mat-option>
            </mat-select>
            <mat-icon matPrefix>priority_high</mat-icon>
            @if (taskForm.get('priority')?.invalid && taskForm.get('priority')?.touched) {
              <mat-error>×‘×—×™×¨×ª ×¢×“×™×¤×•×ª ×”×™× ×—×•×‘×”</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="fill" class="form-field">
            <mat-label>××–×”×” ××—×¨××™</mat-label>
            <input matInput 
                   type="number" 
                   formControlName="assigneeId" 
                   placeholder="0"
                   aria-label="××–×”×” ××—×¨××™ ×¢×œ ×”××©×™××”">
            <mat-icon matPrefix>person</mat-icon>
            @if (taskForm.get('assigneeId')?.invalid && taskForm.get('assigneeId')?.touched) {
              <mat-error>××–×”×” ××—×¨××™ ×”×•× ×©×“×” ×—×•×‘×”</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="fill" class="form-field">
            <mat-label>×ª××¨×™×š ×™×¢×“</mat-label>
            <input matInput type="date" formControlName="dueDate" aria-label="×ª××¨×™×š ×™×¢×“">
            <mat-icon matPrefix>calendar_today</mat-icon>
            @if (taskForm.get('dueDate')?.invalid && taskForm.get('dueDate')?.touched) {
              <mat-error>×ª××¨×™×š ×™×¢×“ ×”×•× ×©×“×” ×—×•×‘×”</mat-error>
            }
          </mat-form-field>
        </div>

        <mat-form-field appearance="fill" class="full-width">
          <mat-label>×ª×™××•×¨ ×”××©×™××”</mat-label>
          <textarea matInput 
                    formControlName="description" 
                    rows="4" 
                    placeholder="×›×ª×•×‘ ×ª×™××•×¨ ××¤×•×¨×˜ ×©×œ ×”××©×™××”..."
                    aria-label="×ª×™××•×¨ ×”××©×™××”"></textarea>
          <mat-icon matPrefix>description</mat-icon>
          @if (taskForm.get('description')?.invalid && taskForm.get('description')?.touched) {
            <mat-error>×ª×™××•×¨ ×”×•× ×©×“×” ×—×•×‘×”</mat-error>
          }
        </mat-form-field>

        <button mat-flat-button color="primary" type="submit" [disabled]="taskForm.invalid" class="submit-btn" aria-label="×”×•×¡×£ ××©×™××” ×—×“×©×”">
          <mat-icon>save</mat-icon> ×©××•×¨ ××©×™××”
        </button>
      </form>
    </mat-card>
  </section>

  <hr class="divider">

  <section class="tasks-container">
    <div class="section-title">
      <h3>××©×™××•×ª ×”×¤×¨×•×™×§×˜ ({{ (tasks$ | async)?.length || 0 }})</h3>
    </div>

    @if (isLoading()) {
      <div class="loading-container">
        <mat-spinner diameter="40"></mat-spinner>
      </div>
    }

   <div class="task-grid">
  @for (task of (tasks$ | async); track task.id) {
    <div class="task-card" [ngClass]="task.status">
      <div class="task-status-bar"></div>
      <div class="task-content">

        @if (editingId !== task.id) {
          <div class="task-top">
            <span class="priority-badge" [attr.data-priority]="task.priority">{{ task.priority }}</span>
            <div class="actions">
               <button mat-icon-button 
                       (click)="editingId = task.id"
                       [attr.aria-label]="'×¢×¨×•×š ××©×™××”: ' + task.title">
                 <mat-icon>edit</mat-icon>
               </button>
               <button mat-icon-button 
                       (click)="deleteTask(task.id)"
                       [attr.aria-label]="'××—×§ ××©×™××”: ' + task.title">
                 <mat-icon>delete_outline</mat-icon>
               </button>
            </div>
          </div>
          
          <h4>{{ task.title }}</h4>
          <p class="desc">{{ task.description }}</p>
          
          <div class="task-footer">
            <span class="date"><mat-icon>calendar_today</mat-icon> {{ task.due_date | date:'dd/MM/yy' }}</span>
            <span class="status-text">{{ task.status }}</span>
          </div>
        } 

      @else {
  <form [formGroup]="updateTask" (ngSubmit)="updateExistingTask(task.id); editingId = null" class="edit-mode-form">
    
    <div class="edit-grid">
      <mat-form-field appearance="fill">
        <mat-label>×›×•×ª×¨×ª</mat-label>
        <input matInput formControlName="title" [placeholder]="task.title" aria-label="×¢×¨×™×›×ª ×›×•×ª×¨×ª ××©×™××”">
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>×¡×˜×˜×•×¡</mat-label>
        <mat-select formControlName="status" aria-label="×¢×¨×™×›×ª ×¡×˜×˜×•×¡">
          <mat-option value="todo">×œ×‘×™×¦×•×¢</mat-option>
          <mat-option value="in_progress">×‘×ª×”×œ×™×š</mat-option>
          <mat-option value="done">×”×•×©×œ×</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>×¢×“×™×¤×•×ª</mat-label>
        <mat-select formControlName="priority" aria-label="×¢×¨×™×›×ª ×¢×“×™×¤×•×ª">
          <mat-option value="low">× ××•×›×”</mat-option>
          <mat-option value="normal">×¨×’×™×œ×”</mat-option>
          <mat-option value="high">×’×‘×•×”×”</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>××–×”×” ××—×¨××™</mat-label>
        <input matInput type="number" formControlName="assignee_id" aria-label="×¢×¨×™×›×ª ××—×¨××™">
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>×ª××¨×™×š</mat-label>
        <input matInput type="date" formControlName="due_date" aria-label="×¢×¨×™×›×ª ×ª××¨×™×š ×™×¢×“">
      </mat-form-field>
    </div>

    <mat-form-field appearance="fill" class="full-width">
      <mat-label>×ª×™××•×¨</mat-label>
      <textarea matInput formControlName="description" rows="2" [placeholder]="task.description"></textarea>
    </mat-form-field>


    <div class="edit-actions">
      <button mat-button type="button" (click)="editingId = null" aria-label="×‘×˜×œ ×¢×¨×™×›×”">×‘×™×˜×•×œ</button>
      <button mat-raised-button color="primary" type="submit" aria-label="×¢×“×›×Ÿ ××ª ×”××©×™××”">×¢×“×›×Ÿ ××©×™××”</button>
    </div>
  </form>
}

      </div>
    </div>
    <div>
       <mat-label>×”×¢×¨×•×ª</mat-label>
      <app-commets [taskId]="task.id"></app-commets>
    </div>
  } 

    @empty {
    <div class="empty-state">
      <mat-icon>assignment_late</mat-icon>
      <p>××™×Ÿ ××©×™××•×ª ×œ×”×¦×’×” ×›×¨×’×¢</p>
    </div>
  }
</div>

  </section>